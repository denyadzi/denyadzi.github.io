<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Blog on embedded programming]]></title>
  <link href="http://denyadzi.github.io/atom.xml" rel="self"/>
  <link href="http://denyadzi.github.io/"/>
  <updated>2015-01-02T15:14:12+03:00</updated>
  <id>http://denyadzi.github.io/</id>
  <author>
    <name><![CDATA[Dzianis Yatskevich]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Triggering External Interrupt on Stm32f4discovery]]></title>
    <link href="http://denyadzi.github.io/blog/2014/12/30/triggering-external-interrupt-on-stm32f4discovery/"/>
    <updated>2014-12-30T08:26:35+03:00</updated>
    <id>http://denyadzi.github.io/blog/2014/12/30/triggering-external-interrupt-on-stm32f4discovery</id>
    <content type="html"><![CDATA[<p>Hello everyone! This post introduces stm32f4xx interrupts and their usage from assembly language. The goal is to react on user-button push (a blue one) using external interrupt. To reach this goal without involving the interrupt we would write a loop &ldquo;listening&rdquo; the input level on the pin. That&rsquo;s a really bad idea because our application should be able to do other useful stuff.</p>

<p>A usual application configures all needed interrupts, peripherals etc. at init stage an then just falls into infinite loop that does nothing - or even it may go to a sleep mode, waking up just to process events and after that go to sleep again.</p>

<!--more-->


<p>To introduce an external interrupt I configure port&rsquo;s A zero pin as input with pulldown resistor. Connecting pulldown resistor guarantees low level at the pin when button is not pressed. Then I configure this pin as the source for external interrupt line 0 - stm32f4xx has a rather flexible external interrupt system (please, refer the user manual). After that additionally I need to mask which lines can generate an interrupt request - in our case it is line 0.</p>

<p>The &ldquo;master&rdquo; of all interrupts and events inside stm32 is the NVIC core peripheral (please refer to <a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/programming_manual/DM00046982.pdf">stm32 programming manual</a> - which is a very useful resource). To get things work I should enable the interrupt coming from channel EXT0_IRQn = 6 (this information is summarized in the interrupt vector table, see <a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/reference_manual/DM00031020.pdf">stm32 reference manual, page 371</a>. Finally I associate some routine to be an interrupt handler by placing it&rsquo;s address to appropriate offset within interrupt vector table.</p>

<p>Let&rsquo;s beging coding. Code for startup and init_clock routines I&rsquo;ve taken from <a href="http://denyadzi.github.io/blog/2014/12/27/clock-control-on-stm32f4discovery/">clock control on stm32f4discovery</a> post. So, the clock source is HSE with 8 MHz crystal. No PLL is used.</p>

<p>I&rsquo;ve decided to share for you two variants of code working with the user button. While I was struggling to make the external interrupt work I wrote a code which works with the user button through a usual loop as a starting point.</p>

<p>Here it is. Now, I&rsquo;m trying to be modular while writing code. Defined constants are included below.</p>

<figure class='code'><figcaption><span> (external_interrupt.S)</span> <a href='http://denyadzi.github.io/public/code/external_interrupt/external_interrupt.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.thumb</span>
</span><span class='line'>    <span class="na">.syntax</span>     <span class="no">unified</span>
</span><span class='line'>    <span class="na">.cpu</span>        <span class="no">cortex-m4</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.include</span>    <span class="s">&quot;registers_and_bits.inc.S&quot;</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">DELAY</span><span class="p">,</span>                  <span class="mi">0x1</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.text</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">_reset</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_reset:</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">startup</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">init_clock</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">gpio_setup</span>
</span><span class='line'>    <span class="nf">b</span>           <span class="no">run</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">_reset</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">run</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">run:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_ODR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">port</span> <span class="no">D</span> <span class="no">output</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r3</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOA_IDR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">port</span> <span class="no">A</span> <span class="no">input</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="err">2:</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>                  <span class="err">/</span><span class="p">*</span> <span class="no">elegant</span> <span class="no">way</span> <span class="no">to</span> <span class="no">clean</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">all</span> <span class="no">LEDs</span> <span class="no">on</span> <span class="no">GPIOD_ODR</span> <span class="no">off</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r4</span><span class="p">,</span> <span class="err">[</span><span class="no">r3</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">reading</span> <span class="no">port</span> <span class="no">A</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="no">ands</span>        <span class="no">r4</span><span class="p">,</span> <span class="no">IDR0</span>                <span class="err">/</span><span class="p">*</span> <span class="no">when</span> <span class="no">button</span> <span class="no">is</span> <span class="no">pressed</span> <span class="p">-</span> <span class="no">high</span> <span class="no">level</span> <span class="no">appears</span> <span class="no">at</span> <span class="no">pin</span> <span class="mi">0</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">super_flash</span>           <span class="err">/</span><span class="p">*</span> <span class="no">make</span> <span class="no">a</span> <span class="no">flash</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r4</span><span class="p">,</span> <span class="err">[</span><span class="no">r3</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">wait</span> <span class="no">for</span> <span class="no">button</span> <span class="no">release</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r4</span><span class="p">,</span> <span class="no">IDR0</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">b</span>           <span class="mi">2</span><span class="no">b</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">run</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">run</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">super_flash</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">super_flash:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">lr</span><span class="err">}</span>                    <span class="err">/</span><span class="p">*</span> <span class="no">we</span> <span class="no">need</span> <span class="no">to</span> <span class="no">preserve</span> <span class="no">the</span> <span class="no">return</span> <span class="no">address</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r5</span><span class="p">,</span> <span class="mi">5</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">as</span> <span class="no">this</span> <span class="no">routine</span> <span class="no">is</span> <span class="no">going</span> <span class="no">to</span> <span class="no">call</span> <span class="no">a</span> <span class="no">subroutine</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_GREEN</span>           <span class="err">/</span><span class="p">*</span> <span class="no">flashing</span> <span class="no">one</span> <span class="no">by</span> <span class="no">one</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_BLUE</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_RED</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_ORANGE</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r5</span><span class="p">,</span> <span class="mi">1</span>                   <span class="err">/</span><span class="p">*</span> <span class="err">&lt;</span><span class="no">r5</span><span class="err">&gt;</span> <span class="no">times</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">lr</span><span class="err">}</span>                    <span class="err">/</span><span class="p">*</span> <span class="no">restore</span> <span class="no">the</span> <span class="no">return</span> <span class="no">address</span> <span class="no">and</span> <span class="no">jump</span> <span class="no">to</span> <span class="no">it</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">super_flash</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">super_flash</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">flash_led</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">flash_led:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">lr</span><span class="err">}</span>                    <span class="err">/</span><span class="p">*</span> <span class="no">in</span> <span class="no">this</span> <span class="no">function</span> <span class="no">it</span> <span class="no">is</span> <span class="no">assumed</span> <span class="no">that</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">r0</span> <span class="no">contains</span> <span class="no">port</span> <span class="no">D</span> <span class="no">address</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">delay</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">r1</span> <span class="no">contains</span> <span class="no">the</span> <span class="no">LED</span> <span class="no">bit</span> <span class="no">to</span> <span class="no">be</span> <span class="no">flashed</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">LED</span> <span class="no">fade</span> <span class="no">out</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">delay</span>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">lr</span><span class="err">}</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">flash_led</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">flash_led</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">delay</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">delay:</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">DELAY</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>               <span class="err">/</span><span class="p">*</span> <span class="no">spend</span> <span class="no">time</span> <span class="no">substracting</span> <span class="no">DELAY</span> <span class="no">value</span> <span class="no">by</span> <span class="mi">1</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>                      <span class="err">/</span><span class="p">*</span> <span class="err">&#39;</span><span class="mi">1</span><span class="no">b</span><span class="err">&#39;</span> <span class="no">means</span> <span class="err">`</span><span class="no">look</span> <span class="no">backward</span> <span class="no">for</span> <span class="no">label</span> <span class="err">&#39;</span><span class="mi">1</span><span class="err">&#39;`</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">delay</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">delay</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">gpio_setup</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">gpio_setup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_AHB1ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">register</span> <span class="no">controls</span> <span class="no">some</span> <span class="no">amount</span> <span class="no">of</span> <span class="no">peripherals</span><span class="err">&#39;</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">GPIODEN</span> <span class="err">|</span> <span class="no">GPIOAEN</span>   <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">GPIOD</span> <span class="no">AND</span> <span class="no">GPIOA</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOA_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">configure</span> <span class="no">GPIOA</span> <span class="no">as</span> <span class="no">input</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">MODER0_IN</span>
</span><span class='line'>    <span class="no">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOA_PUPDR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">connect</span> <span class="no">pulldown</span> <span class="no">resistor</span> <span class="no">to</span> <span class="no">the</span> <span class="no">pin</span> <span class="mi">0</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">PUPDR0_PD</span>
</span><span class='line'>    <span class="no">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">GPIOD</span> <span class="no">mode</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">-</span> <span class="no">all</span> <span class="no">LED</span> <span class="no">pins</span> <span class="no">are</span> <span class="no">outputs</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="no">MODER12_OUT</span> <span class="err">|</span> <span class="no">MODER13_OUT</span> <span class="err">|</span> <span class="no">MODER14_OUT</span> <span class="err">|</span> <span class="no">MODER15_OUT</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">gpio_setup</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">gpio_setup</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">startup</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">startup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">resetting</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">to</span> <span class="no">it</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">defaults</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEON</span><span class="p">,</span> <span class="no">CSSON</span><span class="p">,</span> <span class="no">PLLON</span> <span class="no">bits</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">disabling</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                        <span class="err">/*</span> <span class="nf">HSE</span> <span class="no">oscillator</span><span class="p">,</span> <span class="no">clock</span> <span class="no">security</span> <span class="no">system</span><span class="p">,</span> <span class="no">main</span> <span class="no">PLL</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSION</span>               <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">HSION</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">selecting</span> <span class="no">HSI</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="p">(</span><span class="no">HSEON</span><span class="p">)</span> <span class="err">|</span> <span class="p">(</span><span class="no">CSSON</span><span class="p">)</span> <span class="err">|</span> <span class="p">(</span><span class="no">PLLON</span><span class="p">)</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">RCC_CFGR</span> <span class="p">-</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CIR</span>            <span class="err">/</span><span class="p">*</span> <span class="no">disabling</span> <span class="no">all</span> <span class="no">interrupts</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_PLLCFGR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">the</span> <span class="no">default</span> <span class="no">value</span> <span class="no">from</span> <span class="no">datasheet</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="mi">0x24003010</span>         <span class="err">/</span><span class="p">*</span> <span class="no">for</span> <span class="no">PLL</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">startup</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">startup</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">init_clock</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">init_clock:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">HSE</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEBYP</span>              <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEBYP</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">not</span> <span class="no">bypassing</span> <span class="no">HSE</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEON</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">HSE</span> <span class="no">to</span> <span class="no">be</span> <span class="no">ready</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">HSERDY</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">selecting</span> <span class="no">HSE</span> <span class="no">as</span> <span class="no">the</span> <span class="no">source</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">SW0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">HSE_STARTUP_TIMEOUT</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">source</span> <span class="no">being</span> <span class="no">selected</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">counting</span> <span class="no">some</span> <span class="no">HSE_STARTUP_TIMEOUT</span> <span class="no">value</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">2</span><span class="no">f</span>                      <span class="err">/</span><span class="p">*</span> <span class="no">if</span> <span class="no">HSE</span> <span class="no">doesn</span><span class="err">&#39;</span><span class="no">t</span> <span class="no">start</span> <span class="p">-</span> <span class="no">remain</span> <span class="no">with</span> <span class="no">HSI</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">and</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_SWS</span>
</span><span class='line'>    <span class="nf">cmp</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SWS0</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'><span class="err">2:</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">init_clock</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">init_clock</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.int_vector_table</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="err">%</span><span class="no">progbits</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="err">%</span><span class="no">object</span>
</span><span class='line'><span class="nl">basic_vectors:</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_estack</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_reset</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">basic_vectors</span>
</span></code></pre></td></tr></table></div></figure>


<p>The executable is free to <a href="http://denyadzi.github.io/public/code/external_interrupt/external_interrupt.bin">download</a>. Hope you will get that nice flashing on button pushed.</p>

<p>But as I said earlier that is a bad idea of application design. This code idea is narrow and tied up. We need to use a mini operating system approach not to be tied up. What is it about? The system boots, enables and configures some services needed and then just waits for events. The next code example is exactly about that. Note the <code>b     .</code> line which means &ldquo;jump at current address&rdquo; - the endless loop. After button is pushed the core will jump to _exti_0 and after execution return back to this loop. Whenever a new functionality is needed - it&rsquo;s easy enough to attach it.</p>

<p>Here is the code and defined constants.</p>

<figure class='code'><figcaption><span> (external_interrupt_1.S)</span> <a href='http://denyadzi.github.io/public/code/external_interrupt/external_interrupt_1.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.thumb</span>
</span><span class='line'>    <span class="na">.syntax</span>     <span class="no">unified</span>
</span><span class='line'>    <span class="na">.cpu</span>        <span class="no">cortex-m4</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.include</span>    <span class="s">&quot;registers_and_bits.inc.S&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">DELAY</span><span class="p">,</span>                  <span class="mi">0x1</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.text</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">_reset</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_reset:</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">startup</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">init_clock</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">gpio_setup</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">exti_setup</span>
</span><span class='line'>    <span class="nf">b</span>           <span class="p">.</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">_reset</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">_exti_0</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_exti_0:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">r0</span><span class="p">,</span><span class="no">r1</span><span class="p">,</span><span class="no">lr</span><span class="err">}</span>              <span class="err">/</span><span class="p">*</span> <span class="no">preserve</span> <span class="no">registers</span> <span class="no">being</span> <span class="no">used</span> <span class="no">by</span> <span class="no">routine</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_ODR</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">super_flash</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">EXTI_PR</span>            <span class="err">/</span><span class="p">*</span> <span class="no">after</span> <span class="no">we</span> <span class="no">do</span> <span class="no">nececcary</span> <span class="no">stuff</span> <span class="no">pending</span> <span class="no">bit</span> <span class="no">for</span> <span class="no">current</span> <span class="no">interrupt</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">should</span> <span class="no">be</span> <span class="no">cleared</span> <span class="no">and</span> <span class="no">this</span> <span class="no">is</span> <span class="no">done</span> <span class="no">by</span> <span class="no">setting</span> <span class="no">that</span> <span class="no">bit</span> <span class="no">to</span> <span class="mi">1</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">PR0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">r0</span><span class="p">,</span><span class="no">r1</span><span class="p">,</span><span class="no">lr</span><span class="err">}</span>              <span class="err">/</span><span class="p">*</span> <span class="no">restore</span> <span class="no">registers</span> <span class="no">before</span> <span class="no">leave</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">_exti_0</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_exti_0</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">exti_setup</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">exti_setup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_APB2ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">enable</span> <span class="no">syscfg</span> <span class="no">to</span> <span class="no">be</span> <span class="no">able</span> <span class="no">to</span> <span class="no">configure</span> <span class="no">external</span> <span class="no">interrupt</span> <span class="no">line</span> <span class="no">source</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SYSCFGEN</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">SYSCFG_EXTICR1</span>     <span class="err">/</span><span class="p">*</span> <span class="no">choosing</span> <span class="no">PA0</span> <span class="no">as</span> <span class="no">a</span> <span class="no">source</span> <span class="no">for</span> <span class="no">ext.</span> <span class="no">interrupt</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SYSCFG_EXTICR1_EXTI0</span>
</span><span class='line'>    <span class="no">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">EXTI_IMR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">interrupt</span> <span class="no">mask</span> <span class="no">for</span> <span class="no">line</span> <span class="mi">0</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">MR0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">EXTI_RTSR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">configuring</span> <span class="no">interrupt</span> <span class="no">to</span> <span class="no">be</span> <span class="no">generated</span> <span class="no">on</span> <span class="no">rising</span> <span class="no">edge</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">TR0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">NVIC_ISER0</span>         <span class="err">/</span><span class="p">*</span> <span class="no">enable</span> <span class="no">enterrupt</span> <span class="no">from</span> <span class="no">EXTI0_IRQn</span> <span class="no">channel</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="no">SETENA6</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">exti_setup</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">exti_setup</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">super_flash</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">super_flash:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">r1</span><span class="p">,</span> <span class="no">r5</span><span class="p">,</span> <span class="no">lr</span><span class="err">}</span>            <span class="err">/</span><span class="p">*</span> <span class="no">we</span> <span class="no">need</span> <span class="no">to</span> <span class="no">preserve</span> <span class="no">the</span> <span class="no">return</span> <span class="no">address</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r5</span><span class="p">,</span> <span class="mi">5</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">as</span> <span class="no">this</span> <span class="no">routine</span> <span class="no">is</span> <span class="no">going</span> <span class="no">to</span> <span class="no">call</span> <span class="no">a</span> <span class="no">subroutine</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_GREEN</span>           <span class="err">/</span><span class="p">*</span> <span class="no">flashing</span> <span class="no">one</span> <span class="no">by</span> <span class="no">one</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_BLUE</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_RED</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_ORANGE</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">flash_led</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r5</span><span class="p">,</span> <span class="mi">1</span>                   <span class="err">/</span><span class="p">*</span> <span class="err">&lt;</span><span class="no">r5</span><span class="err">&gt;</span> <span class="no">times</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">r1</span><span class="p">,</span> <span class="no">r5</span><span class="p">,</span> <span class="no">lr</span><span class="err">}</span>            <span class="err">/</span><span class="p">*</span> <span class="no">restore</span> <span class="no">the</span> <span class="no">return</span> <span class="no">address</span> <span class="no">and</span> <span class="no">jump</span> <span class="no">to</span> <span class="no">it</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">super_flash</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">super_flash</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">flash_led</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">flash_led:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">r1</span><span class="p">,</span> <span class="no">lr</span><span class="err">}</span>                <span class="err">/</span><span class="p">*</span> <span class="no">in</span> <span class="no">this</span> <span class="no">function</span> <span class="no">it</span> <span class="no">is</span> <span class="no">assumed</span> <span class="no">that</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">r0</span> <span class="no">contains</span> <span class="no">port</span> <span class="no">D</span> <span class="no">output</span> <span class="no">register</span> <span class="no">address</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">delay</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">r1</span> <span class="no">contains</span> <span class="no">the</span> <span class="no">LED</span> <span class="no">bit</span> <span class="no">to</span> <span class="no">be</span> <span class="no">flashed</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">LED</span> <span class="no">fade</span> <span class="no">out</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">delay</span>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">r1</span><span class="p">,</span> <span class="no">lr</span><span class="err">}</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">flash_led</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">flash_led</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">delay</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">delay:</span>
</span><span class='line'>    <span class="nf">push</span>        <span class="err">{</span><span class="no">r2</span><span class="err">}</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">DELAY</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>               <span class="err">/</span><span class="p">*</span> <span class="no">spend</span> <span class="no">time</span> <span class="no">substracting</span> <span class="no">DELAY</span> <span class="no">value</span> <span class="no">by</span> <span class="mi">1</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>                      <span class="err">/</span><span class="p">*</span> <span class="err">&#39;</span><span class="mi">1</span><span class="no">b</span><span class="err">&#39;</span> <span class="no">means</span> <span class="err">`</span><span class="no">look</span> <span class="no">backward</span> <span class="no">for</span> <span class="no">label</span> <span class="err">&#39;</span><span class="mi">1</span><span class="err">&#39;`</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">pop</span>         <span class="err">{</span><span class="no">r2</span><span class="err">}</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">delay</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">delay</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">gpio_setup</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">gpio_setup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_AHB1ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">register</span> <span class="no">controls</span> <span class="no">some</span> <span class="no">amount</span> <span class="no">of</span> <span class="no">peripherals</span><span class="err">&#39;</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">GPIODEN</span> <span class="err">|</span> <span class="no">GPIOAEN</span>   <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">GPIOD</span> <span class="no">AND</span> <span class="no">GPIOA</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOA_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">configure</span> <span class="no">GPIOA</span> <span class="no">as</span> <span class="no">input</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">MODER0_IN</span>
</span><span class='line'>    <span class="no">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOA_PUPDR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">connect</span> <span class="no">pulldown</span> <span class="no">resistor</span> <span class="no">to</span> <span class="no">the</span> <span class="no">pin</span> <span class="mi">0</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">PUPDR0_PD</span>
</span><span class='line'>    <span class="no">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">GPIOD</span> <span class="no">mode</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">-</span> <span class="no">all</span> <span class="no">LED</span> <span class="no">pins</span> <span class="no">are</span> <span class="no">outputs</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="no">MODER12_OUT</span> <span class="err">|</span> <span class="no">MODER13_OUT</span> <span class="err">|</span> <span class="no">MODER14_OUT</span> <span class="err">|</span> <span class="no">MODER15_OUT</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">gpio_setup</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">gpio_setup</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">startup</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">startup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">resetting</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">to</span> <span class="no">it</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">defaults</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEON</span><span class="p">,</span> <span class="no">CSSON</span><span class="p">,</span> <span class="no">PLLON</span> <span class="no">bits</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">disabling</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                        <span class="err">/*</span> <span class="nf">HSE</span> <span class="no">oscillator</span><span class="p">,</span> <span class="no">clock</span> <span class="no">security</span> <span class="no">system</span><span class="p">,</span> <span class="no">main</span> <span class="no">PLL</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSION</span>               <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">HSION</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">selecting</span> <span class="no">HSI</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="no">HSEON</span> <span class="err">|</span> <span class="no">CSSON</span> <span class="err">|</span> <span class="no">PLLON</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">RCC_CFGR</span> <span class="p">-</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CIR</span>            <span class="err">/</span><span class="p">*</span> <span class="no">disabling</span> <span class="no">all</span> <span class="no">interrupts</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_PLLCFGR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">the</span> <span class="no">default</span> <span class="no">value</span> <span class="no">from</span> <span class="no">datasheet</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="mi">0x24003010</span>         <span class="err">/</span><span class="p">*</span> <span class="no">for</span> <span class="no">PLL</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">startup</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">startup</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">init_clock</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">init_clock:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">HSE</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEBYP</span>              <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEBYP</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">not</span> <span class="no">bypassing</span> <span class="no">HSE</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEON</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">HSE</span> <span class="no">to</span> <span class="no">be</span> <span class="no">ready</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">HSERDY</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">selecting</span> <span class="no">HSE</span> <span class="no">as</span> <span class="no">the</span> <span class="no">source</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">SW0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">HSE_STARTUP_TIMEOUT</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">source</span> <span class="no">being</span> <span class="no">selected</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">counting</span> <span class="no">some</span> <span class="no">HSE_STARTUP_TIMEOUT</span> <span class="no">value</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">2</span><span class="no">f</span>                      <span class="err">/</span><span class="p">*</span> <span class="no">if</span> <span class="no">HSE</span> <span class="no">doesn</span><span class="err">&#39;</span><span class="no">t</span> <span class="no">start</span> <span class="p">-</span> <span class="no">remain</span> <span class="no">with</span> <span class="no">HSI</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">and</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_SWS</span>
</span><span class='line'>    <span class="nf">cmp</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SWS0</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'><span class="err">2:</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">init_clock</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">init_clock</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.int_vector_table</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="err">%</span><span class="no">progbits</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="err">%</span><span class="no">object</span>
</span><span class='line'><span class="nl">basic_vectors:</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_estack</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_reset</span>
</span><span class='line'>    <span class="na">.org</span>        <span class="mi">0x58</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_exti_0</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">basic_vectors</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (registers_and_bits.inc.S)</span> <a href='http://denyadzi.github.io/public/code/external_interrupt/registers_and_bits.inc.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_BASE</span><span class="p">,</span>       <span class="mi">0x40023800</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CR</span>  <span class="p">,</span>       <span class="no">RCC_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR</span><span class="p">,</span>       <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x08</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_PLLCFGR</span><span class="p">,</span>    <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x04</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_AHB1ENR</span><span class="p">,</span>    <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x30</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_APB2ENR</span><span class="p">,</span>    <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x44</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CIR</span><span class="p">,</span>        <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x0C</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_BASE</span><span class="p">,</span>     <span class="mi">0x40020C00</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_MODER</span><span class="p">,</span>    <span class="no">GPIOD_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_ODR</span><span class="p">,</span>      <span class="no">GPIOD_BASE</span> <span class="err">+</span> <span class="mi">0x14</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOA_BASE</span><span class="p">,</span>     <span class="mi">0x40020000</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOA_MODER</span><span class="p">,</span>    <span class="no">GPIOA_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOA_PUPDR</span><span class="p">,</span>    <span class="no">GPIOA_BASE</span> <span class="err">+</span> <span class="mi">0x0C</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOA_IDR</span><span class="p">,</span>      <span class="no">GPIOA_BASE</span> <span class="err">+</span> <span class="mi">0x10</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SYSCFG_BASE</span><span class="p">,</span>    <span class="mi">0x40013800</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SYSCFG_EXTICR1</span><span class="p">,</span> <span class="no">SYSCFG_BASE</span> <span class="err">+</span> <span class="mi">0x08</span>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">EXTI_BASE</span><span class="p">,</span>      <span class="mi">0x40013C00</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">EXTI_IMR</span><span class="p">,</span>       <span class="no">EXTI_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">EXTI_RTSR</span><span class="p">,</span>      <span class="no">EXTI_BASE</span> <span class="err">+</span> <span class="mi">0x08</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">EXTI_PR</span><span class="p">,</span>        <span class="no">EXTI_BASE</span> <span class="err">+</span> <span class="mi">0x14</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">NVIC_BASE</span><span class="p">,</span>      <span class="mi">0xE000E100</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">NVIC_ISER0</span><span class="p">,</span>     <span class="no">NVIC_BASE</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIODEN</span><span class="p">,</span>        <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">3</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOAEN</span><span class="p">,</span>        <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SYSCFGEN</span><span class="p">,</span>       <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">14</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER12_OUT</span><span class="p">,</span>    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">24</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER13_OUT</span><span class="p">,</span>    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">26</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER14_OUT</span><span class="p">,</span>    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">28</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER15_OUT</span><span class="p">,</span>    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">30</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER0_IN</span><span class="p">,</span>      <span class="mi">0x3</span>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">LED_GREEN</span><span class="p">,</span>      <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">12</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">LED_ORANGE</span><span class="p">,</span>     <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">13</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">LED_RED</span><span class="p">,</span>        <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">14</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">LED_BLUE</span><span class="p">,</span>       <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">15</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLLON</span><span class="p">,</span>          <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">24</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSION</span><span class="p">,</span>          <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSEBYP</span><span class="p">,</span>         <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">18</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSEON</span><span class="p">,</span>          <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">16</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSERDY</span><span class="p">,</span>         <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">17</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">CSSON</span><span class="p">,</span>          <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">19</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SW0</span><span class="p">,</span>            <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SWS0</span><span class="p">,</span>           <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">PUPDR0_PD</span><span class="p">,</span>      <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">IDR0</span><span class="p">,</span>           <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MR0</span><span class="p">,</span>            <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">TR0</span><span class="p">,</span>            <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PR0</span><span class="p">,</span>            <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">EXTI0_IRQn</span><span class="p">,</span>     <span class="mi">6</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SETENA6</span><span class="p">,</span>        <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="no">EXTI0_IRQn</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSE_STARTUP_TIMEOUT</span><span class="p">,</span>    <span class="mi">0x1</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR_SWS</span><span class="p">,</span>           <span class="mi">3</span> <span class="err">&lt;&lt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOx_PUPDR0</span><span class="p">,</span>           <span class="mi">3</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SYSCFG_EXTICR1_EXTI0</span><span class="p">,</span>   <span class="mi">0xF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ready executable: <a href="http://denyadzi.github.io/public/code/external_interrupt/external_interrupt_1.bin">download</a>.</p>

<p>Note the stack usage in these examples. The routine preserves registers&#8217; contents by pushing it into the stack at the very start of execution and popping it before leave. I think that is absolutely necessary in interrupt handle routines because of randomity of accesses to them. Though, I may be wrong and there may be better aproaches to that.</p>

<p>Feel free to write for conversations.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Stm32f4 168 MHz Speedup]]></title>
    <link href="http://denyadzi.github.io/blog/2014/12/28/stm32f4-168-mhz-speedup/"/>
    <updated>2014-12-28T12:10:19+03:00</updated>
    <id>http://denyadzi.github.io/blog/2014/12/28/stm32f4-168-mhz-speedup</id>
    <content type="html"><![CDATA[<p>Hello everyone! Current post is based on <a href="http://denyadzi.github.io/blog/2014/12/27/clock-control-on-stm32f4discovery/">clock control on stm32f4discovery</a> post. Now, after some of new material has been read on the topic, I&rsquo;m going to switch to the recommended maximum frequency of stm32f407 system clock - 168 MHz.</p>

<!--more-->


<p>That&rsquo;s easy enough. I&rsquo;m going just to modify the init_clock routine from previous example by adding some configuration:</p>

<ul>
<li><em>Flash</em>: the higher the frequency the more clock cycles CPU needs to wait for flash reaction. There is a table in <a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/reference_manual/DM00031020.pdf">user manual, page 80</a> from which the value of this parameter can be taken. In our case it is 6 cycles or 5 so called &ldquo;wait states&rdquo;. The FLASH_ACR registry holds this parameter.</li>
<li><em>Power controller</em>: to operate on 168 MHz the MC need voltage controller enabled and the voltage mode scale 1 to be selected. This is done on PWR_CR register.</li>
<li>The peripherals have clock frequency limits for normal operation. For high speed devices on APB2 it is 84 MHz and for low speed on APB1 - 42 MHz. So we need to set apropriate <em>prescaling</em> factors on RCC_CFGR register. They are 168 / 84 = 2 and 168 / 42 = 4 respectively.</li>
<li>Finally we configure, enable and select the <em>main PLL</em> as the source of a system clock. The output signal frequency of main PLL is calculated in such a way:</li>
</ul>


<p>fout = (fin * N / M) / P</p>

<p>Where fin - is 8 MHz from HSE with external crystal,
it is convenient to take M value the same as the fin and equal 8 in our case,
P - takes minimum of 2</p>

<p>So, N = 168 * 2 = 336. All these factors are set in RCC_PLLCFGR register.</p>

<p>Please, checkout the code for details:</p>

<figure class='code'><figcaption><span> (speed_up.S)</span> <a href='http://denyadzi.github.io/public/code/changing_clock/speed_up.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.thumb</span>
</span><span class='line'>    <span class="na">.syntax</span>     <span class="no">unified</span>
</span><span class='line'>    <span class="na">.cpu</span>        <span class="no">cortex-m4</span>
</span><span class='line'>
</span><span class='line'><span class="na">.include</span>        <span class="s">&quot;registers_and_bits.inc.S&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.text</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">_reset</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_reset:</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Lstartup</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Linit_clock</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_AHB1ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">register</span> <span class="no">controls</span> <span class="no">some</span> <span class="no">part</span> <span class="no">of</span> <span class="no">peripherals</span><span class="err">&#39;</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">GPIODEN</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">GPIOD</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">GPIOD</span> <span class="no">mode</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="no">MODER12_OUT</span>        <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="mi">12</span> <span class="no">pin</span> <span class="no">of</span> <span class="no">GPIOD</span> <span class="no">as</span> <span class="no">output</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_ODR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">port</span> <span class="no">output</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>                  <span class="err">/</span><span class="p">*</span> <span class="no">elegant</span> <span class="no">way</span> <span class="no">to</span> <span class="no">clean</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r2</span> <span class="p">,</span><span class="no">r2</span>
</span><span class='line'><span class="nl">.Lblink:</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_GREEN</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">LED_GREEN</span> <span class="no">bit</span> <span class="no">in</span> <span class="no">GPIOD_ODR</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Ldelay</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">GPIOD_ODR</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Ldelay</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">b</span>           <span class="no">.Lblink</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">so</span> <span class="no">on</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="nl">.Ldelay:</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">DELAY</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>               <span class="err">/</span><span class="p">*</span> <span class="no">spend</span> <span class="no">time</span> <span class="no">substracting</span> <span class="no">DELAY</span> <span class="no">value</span> <span class="no">by</span> <span class="mi">1</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>                      <span class="err">/</span><span class="p">*</span> <span class="err">&#39;</span><span class="mi">1</span><span class="no">b</span><span class="err">&#39;</span> <span class="no">means</span> <span class="err">`</span><span class="no">look</span> <span class="no">backward</span> <span class="no">for</span> <span class="no">label</span> <span class="err">&#39;</span><span class="mi">1</span><span class="err">&#39;`</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'><span class="nl">.Lstartup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">resetting</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">to</span> <span class="no">it</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">defaults</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSION</span>               <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">HSION</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">RCC_CFGR</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEON</span><span class="p">,</span> <span class="no">CSSON</span><span class="p">,</span> <span class="no">PLLON</span> <span class="no">bits</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="no">HSEON</span> <span class="err">|</span> <span class="no">CSSON</span> <span class="err">|</span> <span class="no">PLLON</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_PLLCFGR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">the</span> <span class="no">default</span> <span class="no">value</span> <span class="no">from</span> <span class="no">datasheet</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="mi">0x24003010</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEBYP</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEBYP</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CIR</span>            <span class="err">/</span><span class="p">*</span> <span class="no">disabling</span> <span class="no">all</span> <span class="no">interrupts</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'><span class="nl">.Linit_clock:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">HSE</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEON</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">HSE</span> <span class="no">to</span> <span class="no">be</span> <span class="no">ready</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">HSERDY</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_APB1ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">enable</span> <span class="no">power</span> <span class="no">controller</span> <span class="no">and</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">select</span> <span class="no">regulator</span> <span class="no">voltage</span> <span class="no">scale</span> <span class="no">mode</span> <span class="mi">1</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">PWREN</span>               <span class="err">/</span><span class="p">*</span> <span class="no">to</span> <span class="no">be</span> <span class="no">able</span> <span class="no">to</span> <span class="no">work</span> <span class="no">on</span> <span class="mi">168</span> <span class="no">MHz</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">PWR_CR</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">VOS</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">configuring</span> <span class="no">peripherals</span> <span class="no">clock</span> <span class="no">prescaling</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_HPRE_DIV1</span>  <span class="err">/</span><span class="p">*</span> <span class="no">explicitly</span> <span class="no">setting</span> <span class="no">no</span> <span class="no">devision</span> <span class="no">for</span> <span class="no">AHB</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_PPRE2_DIV2</span> <span class="err">/</span><span class="p">*</span> <span class="mi">168</span> <span class="err">/</span> <span class="mi">2</span> <span class="err">&lt;=</span> <span class="mi">84</span> <span class="no">MHz</span> <span class="no">for</span> <span class="no">high</span> <span class="no">speed</span> <span class="no">devices</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_PPRE1_DIV4</span> <span class="err">/</span><span class="p">*</span> <span class="mi">168</span> <span class="err">/</span> <span class="mi">4</span> <span class="err">&lt;=</span> <span class="mi">42</span> <span class="no">MHz</span> <span class="no">for</span> <span class="no">low</span> <span class="no">speed</span> <span class="no">devices</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_PLLCFGR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">configuring</span> <span class="no">main</span> <span class="no">PLL</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="no">PLL_M</span> <span class="err">|</span> <span class="no">PLL_N</span> <span class="err">&lt;&lt;</span> <span class="mi">6</span> <span class="err">|</span> <span class="p">((</span><span class="no">PLL_P</span> <span class="err">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="err">&lt;&lt;</span> <span class="mi">16</span> <span class="err">|</span> <span class="no">PLLSRC</span> <span class="err">|</span> <span class="no">PLL_Q</span> <span class="err">&lt;&lt;</span> <span class="mi">24</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enable</span> <span class="no">main</span> <span class="no">PLL</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">PLLON</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">wait</span> <span class="no">for</span> <span class="no">PLL</span> <span class="no">to</span> <span class="no">be</span> <span class="no">ready</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">PLLRDY</span>
</span><span class='line'>    <span class="no">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">FLASH_ACR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">encreasing</span> <span class="no">flash</span> <span class="no">latency</span> <span class="no">clock</span> <span class="no">cycles</span> <span class="no">amount</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">in</span> <span class="no">general</span> <span class="no">this</span> <span class="no">parameter</span> <span class="no">depends</span> <span class="no">on</span> <span class="no">Vdd</span> <span class="no">and</span> <span class="no">system</span> <span class="no">clock</span> <span class="no">frequency</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="no">ACR_LATENCY_5WS</span>    <span class="err">/</span><span class="p">*</span> <span class="no">in</span> <span class="no">our</span> <span class="no">case</span> <span class="no">it</span> <span class="no">is</span> <span class="mi">6</span> <span class="no">cycles</span> <span class="p">(</span><span class="no">or</span> <span class="mi">5</span> <span class="err">&quot;</span><span class="no">wait</span> <span class="no">states</span><span class="err">&quot;</span><span class="p">)</span> <span class="no">according</span> <span class="no">to</span> <span class="no">the</span> <span class="no">manual</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">selecting</span> <span class="no">PLL</span> <span class="no">as</span> <span class="no">a</span> <span class="no">source</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SW1</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">and</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_SWS</span>
</span><span class='line'>    <span class="nf">cmp</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SWS1</span>
</span><span class='line'>    <span class="no">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">_reset</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.int_vector_table</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="err">%</span><span class="no">progbits</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="err">%</span><span class="no">object</span>
</span><span class='line'><span class="nl">basic_vectors:</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_estack</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">basic_vectors</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span> (registers_and_bits.inc.S)</span> <a href='http://denyadzi.github.io/public/code/changing_clock/registers_and_bits.inc.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_BASE</span><span class="p">,</span>               <span class="mi">0x40023800</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CR</span><span class="p">,</span>                 <span class="no">RCC_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR</span><span class="p">,</span>               <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x08</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_PLLCFGR</span><span class="p">,</span>            <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x04</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_AHB1ENR</span><span class="p">,</span>            <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x30</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_APB1ENR</span><span class="p">,</span>            <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x40</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CIR</span><span class="p">,</span>                <span class="no">RCC_BASE</span> <span class="err">+</span> <span class="mi">0x0C</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PWR_BASE</span><span class="p">,</span>               <span class="mi">0x40007000</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PWR_CR</span><span class="p">,</span>                 <span class="no">PWR_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">FLASH_BASE</span><span class="p">,</span>             <span class="mi">0x40023C00</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">FLASH_ACR</span><span class="p">,</span>              <span class="no">FLASH_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_BASE</span><span class="p">,</span>             <span class="mi">0x40020C00</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_MODER</span><span class="p">,</span>            <span class="no">GPIOD_BASE</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIOD_ODR</span><span class="p">,</span>              <span class="no">GPIOD_BASE</span> <span class="err">+</span> <span class="mi">0x14</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">GPIODEN</span><span class="p">,</span>                <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">3</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">MODER12_OUT</span><span class="p">,</span>            <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">24</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">LED_GREEN</span><span class="p">,</span>              <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">12</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLLON</span><span class="p">,</span>                  <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">24</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLLRDY</span><span class="p">,</span>                 <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">25</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLLSRC</span><span class="p">,</span>                 <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">22</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSION</span><span class="p">,</span>                  <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSEBYP</span><span class="p">,</span>                 <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">18</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSEON</span><span class="p">,</span>                  <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">16</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">HSERDY</span><span class="p">,</span>                 <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">17</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">CSSON</span><span class="p">,</span>                  <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">19</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PWREN</span><span class="p">,</span>                  <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">28</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">VOS</span><span class="p">,</span>                    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">14</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SW0</span><span class="p">,</span>                    <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SW1</span><span class="p">,</span>                    <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">1</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SWS0</span><span class="p">,</span>                   <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">SWS1</span><span class="p">,</span>                   <span class="mi">1</span> <span class="err">&lt;&lt;</span> <span class="mi">3</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">PLL_M</span><span class="p">,</span>                  <span class="mi">8</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLL_N</span><span class="p">,</span>                  <span class="mi">336</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLL_P</span><span class="p">,</span>                  <span class="mi">2</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">PLL_Q</span><span class="p">,</span>                  <span class="mi">7</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">DELAY</span><span class="p">,</span>                  <span class="mi">0x5F</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">ACR_LATENCY_5WS</span><span class="p">,</span>        <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">RCC_PLLCFGR_PLLP</span><span class="p">,</span>       <span class="err">~</span><span class="p">(</span><span class="mi">0x3</span> <span class="err">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_PLLCFGR_PLLM</span><span class="p">,</span>       <span class="err">~</span><span class="mi">0x3F</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_PLLCFGR_PLLN</span><span class="p">,</span>       <span class="err">~</span><span class="p">(</span><span class="mi">0x1FF</span> <span class="err">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR_HPRE_DIV1</span><span class="p">,</span>     <span class="mi">0xF</span> <span class="err">&lt;&lt;</span> <span class="mi">4</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR_PPRE2_DIV2</span><span class="p">,</span>    <span class="mi">0x8000</span>
</span><span class='line'>    <span class="no">.equ</span>        <span class="no">RCC_CFGR_PPRE1_DIV4</span><span class="p">,</span>    <span class="mi">0x1400</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR_SW</span><span class="p">,</span>            <span class="mi">3</span>
</span><span class='line'>    <span class="na">.equ</span>        <span class="no">RCC_CFGR_SWS</span><span class="p">,</span>           <span class="mi">3</span> <span class="err">&lt;&lt;</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>The executable is available to <a href="http://denyadzi.github.io/public/code/changing_clock/speed_up.elf.bin">download</a>.</p>

<p>Feel free to post your questions.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Clock Control on Stm32f4discovery]]></title>
    <link href="http://denyadzi.github.io/blog/2014/12/27/clock-control-on-stm32f4discovery/"/>
    <updated>2014-12-27T07:14:29+03:00</updated>
    <id>http://denyadzi.github.io/blog/2014/12/27/clock-control-on-stm32f4discovery</id>
    <content type="html"><![CDATA[<p>Hello everyone! This post is dedicated to learning clock configuration of our stm32f4. By default MC is driven by the internal oscillator (HSI) which generates 16 MHz signal. The Internal oscillator frequency stability isn&rsquo;t good enough for real world applications. There is a 8 MHz crystal on board of stm32f4discovery. The crystal is needed for another one oscillator called HSE. This oscillator has better than HSI frequency stability characteristics. So we need to know how to change the source of a system clock-signal of the MC.</p>

<!--more-->


<p>Just switching to the HSE oscillator will set the frequency of clock-signal to 8 MHz. This value is low for being the &ldquo;heartbeat&rdquo; of a modern device. Here comes the PLL peripheral which&rsquo;s aim is to multiply signal&rsquo;s frequency by some factor. Using PLL makes it possible to reach the clock-signal frequency up to 168 MHz.</p>

<p>I&rsquo;ve played with it for a while&hellip; And here is the story. There were no problems while selecting HSE as the source. Configuring and enabling PLL is also simple. But some strange crazy things started happening after I selected PLL as the source for a system clock. The most unpleasant ones were random fails of burning into the flash or burning into the wrong address of flash&hellip;</p>

<p>I took one of the example sources from ST library then and there I saw much preparatory stuff before speeding up the device - including some flash configuration. Fairly speaking, dealing with IDE isolates a programmer from such an experience - all the preparation is done behind the scenes before the main routine is called and everything is working fine. But such experience of investigating some problem is a real charm. That&rsquo;s why avoiding problems should not be our way.</p>

<p>So, in this post we won&rsquo;t jump so high (or low ?? :) ). The purpose is to switch to the HSE oscillator.</p>

<h2>The code</h2>

<p>The program is a simple one-led-blinking program, here is the source code:</p>

<figure class='code'><figcaption><span> (changing_clock.S)</span> <a href='http://denyadzi.github.io/public/code/changing_clock/changing_clock.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.thumb</span>
</span><span class='line'>    <span class="na">.syntax</span>     <span class="no">unified</span>
</span><span class='line'>    <span class="na">.cpu</span>        <span class="no">cortex-m4</span>
</span><span class='line'><span class="c">#define RCC_BASE            0x40023800</span>
</span><span class='line'><span class="c">#define RCC_CR              RCC_BASE</span>
</span><span class='line'><span class="c">#define RCC_CFGR            RCC_BASE + 0x08</span>
</span><span class='line'><span class="c">#define RCC_PLLCFGR         RCC_BASE + 0x04</span>
</span><span class='line'><span class="c">#define RCC_AHB1ENR         RCC_BASE + 0x30</span>
</span><span class='line'><span class="c">#define RCC_CIR             RCC_BASE + 0x0C</span>
</span><span class='line'><span class="c">#define GPIOD_BASE          0x40020C00</span>
</span><span class='line'><span class="c">#define GPIOD_MODER         GPIOD_BASE</span>
</span><span class='line'><span class="c">#define GPIOD_ODR           GPIOD_BASE + 0x14</span>
</span><span class='line'>
</span><span class='line'><span class="c">#define GPIODEN             1 &lt;&lt; 3</span>
</span><span class='line'><span class="c">#define MODER12_OUT         1 &lt;&lt; 24</span>
</span><span class='line'><span class="c">#define LED_GREEN           1 &lt;&lt; 12</span>
</span><span class='line'><span class="c">#define PLLON               1 &lt;&lt; 24</span>
</span><span class='line'><span class="c">#define HSION               1</span>
</span><span class='line'><span class="c">#define HSEBYP              1 &lt;&lt; 18</span>
</span><span class='line'><span class="c">#define HSEON               1 &lt;&lt; 16</span>
</span><span class='line'><span class="c">#define HSERDY              1 &lt;&lt; 17</span>
</span><span class='line'><span class="c">#define CSSON               1 &lt;&lt; 19</span>
</span><span class='line'><span class="c">#define SW0                 1</span>
</span><span class='line'><span class="c">#define SWS0                1 &lt;&lt; 2             </span>
</span><span class='line'>
</span><span class='line'><span class="c">#define DELAY               0x5F</span>
</span><span class='line'><span class="c">#define HSE_STARTUP_TIMEOUT 0x1</span>
</span><span class='line'>
</span><span class='line'><span class="c">#define RCC_CFGR_SWS        3 &lt;&lt; 2</span>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.text</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">_reset</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_reset:</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Lstartup</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Linit_clock</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_AHB1ENR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">register</span> <span class="no">controls</span> <span class="no">some</span> <span class="no">amount</span> <span class="no">of</span> <span class="no">peripherals</span><span class="err">&#39;</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">GPIODEN</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">GPIOD</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_MODER</span>        <span class="err">/</span><span class="p">*</span> <span class="no">GPIOD</span> <span class="no">mode</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="no">MODER12_OUT</span>        <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="mi">12</span> <span class="no">pin</span> <span class="no">of</span> <span class="no">GPIOD</span> <span class="no">as</span> <span class="no">output</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_ODR</span>          <span class="err">/</span><span class="p">*</span> <span class="no">port</span> <span class="no">output</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>                  <span class="err">/</span><span class="p">*</span> <span class="no">elegant</span> <span class="no">way</span> <span class="no">to</span> <span class="no">clean</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r2</span> <span class="p">,</span><span class="no">r2</span>
</span><span class='line'><span class="nl">.Lblink:</span>
</span><span class='line'>    <span class="nf">mov</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">LED_GREEN</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">LED_GREEN</span> <span class="no">bit</span> <span class="no">in</span> <span class="no">GPIOD_ODR</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Ldelay</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r1</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">GPIOD_ODR</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>          <span class="no">.Ldelay</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">b</span>           <span class="no">.Lblink</span>                 <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">so</span> <span class="no">on</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'><span class="nl">.Ldelay:</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">DELAY</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>               <span class="err">/</span><span class="p">*</span> <span class="no">spend</span> <span class="no">time</span> <span class="no">substracting</span> <span class="no">DELAY</span> <span class="no">value</span> <span class="no">by</span> <span class="mi">1</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>                      <span class="err">/</span><span class="p">*</span> <span class="err">&#39;</span><span class="mi">1</span><span class="no">b</span><span class="err">&#39;</span> <span class="no">means</span> <span class="err">`</span><span class="no">look</span> <span class="no">backward</span> <span class="no">for</span> <span class="no">label</span> <span class="err">&#39;</span><span class="mi">1</span><span class="err">&#39;`</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>
</span><span class='line'><span class="nl">.Lstartup:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">resetting</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">to</span> <span class="no">it</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">defaults</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEON</span><span class="p">,</span> <span class="no">CSSON</span><span class="p">,</span> <span class="no">PLLON</span> <span class="no">bits</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">disabling</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                        <span class="err">/*</span> <span class="nf">HSE</span> <span class="no">oscillator</span><span class="p">,</span> <span class="no">clock</span> <span class="no">security</span> <span class="no">system</span><span class="p">,</span> <span class="no">main</span> <span class="no">PLL</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSION</span>               <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">HSION</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">directly</span> <span class="no">selecting</span> <span class="no">HSI</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="p">(</span><span class="no">HSEON</span><span class="p">)</span> <span class="err">|</span> <span class="p">(</span><span class="no">CSSON</span><span class="p">)</span> <span class="err">|</span> <span class="p">(</span><span class="no">PLLON</span><span class="p">)</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">RCC_CFGR</span> <span class="p">-</span> <span class="no">clock</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CIR</span>            <span class="err">/</span><span class="p">*</span> <span class="no">disabling</span> <span class="no">all</span> <span class="no">interrupts</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_PLLCFGR</span>        <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">the</span> <span class="no">default</span> <span class="no">value</span> <span class="no">from</span> <span class="no">datasheet</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="mi">0x24003010</span>         <span class="err">/</span><span class="p">*</span> <span class="no">for</span> <span class="no">PLL</span> <span class="no">configuration</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>
</span><span class='line'><span class="nl">.Linit_clock:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CR</span>             <span class="err">/</span><span class="p">*</span> <span class="no">enabling</span> <span class="no">HSE</span> <span class="no">clock</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bic</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEBYP</span>              <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">HSEBYP</span> <span class="no">bit</span> <span class="p">-</span> <span class="no">not</span> <span class="no">bypassing</span> <span class="no">HSE</span> <span class="no">oscillator</span><span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">HSEON</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">HSE</span> <span class="no">to</span> <span class="no">be</span> <span class="no">ready</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ands</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">HSERDY</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_CFGR</span>           <span class="err">/</span><span class="p">*</span> <span class="no">selecting</span> <span class="no">HSE</span> <span class="no">as</span> <span class="no">the</span> <span class="no">source</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>        <span class="no">r1</span><span class="p">,</span> <span class="no">SW0</span>
</span><span class='line'>    <span class="nf">str</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">eor</span>         <span class="no">r2</span><span class="p">,</span> <span class="no">r2</span>
</span><span class='line'>    <span class="nf">movt</span>        <span class="no">r2</span><span class="p">,</span> <span class="no">HSE_STARTUP_TIMEOUT</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">ldr</span>         <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>                <span class="err">/</span><span class="p">*</span> <span class="no">waiting</span> <span class="no">for</span> <span class="no">source</span> <span class="no">being</span> <span class="no">selected</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">subs</span>        <span class="no">r2</span><span class="p">,</span> <span class="mi">1</span>                   <span class="err">/</span><span class="p">*</span> <span class="no">counting</span> <span class="no">some</span> <span class="no">HSE_STARTUP_TIMEOUT</span> <span class="no">value</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">beq</span>         <span class="mi">2</span><span class="no">f</span>                      <span class="err">/</span><span class="p">*</span> <span class="no">if</span> <span class="no">HSE</span> <span class="no">doesn</span><span class="err">&#39;</span><span class="no">t</span> <span class="no">start</span> <span class="p">-</span> <span class="no">remain</span> <span class="no">with</span> <span class="no">HSI</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">and</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">RCC_CFGR_SWS</span>
</span><span class='line'>    <span class="nf">cmp</span>         <span class="no">r1</span><span class="p">,</span> <span class="no">SWS0</span>
</span><span class='line'>    <span class="nf">bne</span>         <span class="mi">1</span><span class="no">b</span>
</span><span class='line'><span class="err">2:</span>
</span><span class='line'>    <span class="nf">bx</span>          <span class="no">lr</span>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">_reset</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>        <span class="no">.int_vector_table</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="err">%</span><span class="no">progbits</span>
</span><span class='line'>    <span class="na">.type</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="err">%</span><span class="no">object</span>
</span><span class='line'><span class="nl">basic_vectors:</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_estack</span>
</span><span class='line'>    <span class="na">.word</span>       <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.size</span>       <span class="no">basic_vectors</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">basic_vectors</span>
</span></code></pre></td></tr></table></div></figure>


<p>Routines called delay and blink are similar to those in <a href="http://denyadzi.github.io/blog/2014/12/25/assembly-hello-world-code-for-stm32f4discovery/">assembly hello world code for stm32f4discovery</a> post. This code introduces two new routines : startup and init_clock.</p>

<p>Startup initializes default clock configuration. Actually it&rsquo;s not neccesary but it is a good practice and should be done. For example: it is said that main PLLON bit reset value is 0 in stm32f4xx user manual, but on my board it is seen with the debugger that the PLLON bit is &ldquo;1&rdquo; after reset. So, the conclusion which is not new in a programming world is: not to rely on something not initialized explicitly. The startup just selects HSI as the clock source; disables HSE, PLL, clock security; resets PLL configuration to the datasheet value; disables interrupts.</p>

<p>The clock_init routine enables HSE, selects it as the system clock&rsquo;s source and waits for it to be ready, but if some error occurs - it will continue with HSI clock after a little delay. Note: this is just an example and it is not neccessary to do exactly the same thing whenever HSE is selected.</p>

<p>To detect the difference you may test the code without the following line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'><span class="nf">bl</span>      <span class="no">.Linit_clock</span>
</span></code></pre></td></tr></table></div></figure>


<p>HSI clock will be selected if init_clock is not called and the frequency will be twice higher than in the case init_clock is called. So the blinking will be also twice faster.</p>

<p>Compiling the code remains yet the same as in previous post. Also here is the result binary for <a href="http://denyadzi.github.io/public/code/changing_clock/changing_clock.elf.bin">download</a></p>

<p>Feel free to write letters for conversations.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Assembly Hello World Code for Stm32f4discovery]]></title>
    <link href="http://denyadzi.github.io/blog/2014/12/25/assembly-hello-world-code-for-stm32f4discovery/"/>
    <updated>2014-12-25T14:22:40+03:00</updated>
    <id>http://denyadzi.github.io/blog/2014/12/25/assembly-hello-world-code-for-stm32f4discovery</id>
    <content type="html"><![CDATA[<p>Hello everyone! First of all: why use assembly language? In my opinion one should remove any kind of intermediary to know something well - remove anything that can be removed and examine the target directly. When programing for PC it&rsquo;s common not to think what processor is going to execute the code. We don&rsquo;t think about the amount of bytes that are generated for the execution. I&rsquo;m talking just about the corresponing level of abstraction - tools should correspond to the task.</p>

<p>The task for this post is:</p>

<ul>
<li>to realize the stm32f4 memory layout</li>
<li>to know what&rsquo;s going on after microcontroller (or MC) is powered up</li>
<li>to get familiar with stm32f4 IO port with writing basic blinking program</li>
</ul>


<!--more-->


<p>Knowing how to work with IO port gives you already a real possibility to create a variaty of MC applications. So, let&rsquo;s begin.</p>

<h2>Memory layout and linker script</h2>

<p>After the code is compiled and assembled the linkage stage comes on. When code is broken into several source files the assebmling gives several so called object files - these are input files for the linker and it&rsquo;s output is a single object file or an executable.</p>

<p>All input files have, for example, code and data segments. The output file also should then have both of them, contaning the summary of all input data and code segments respectively - all input data segments concatenate into one output data segment and so on. That&rsquo;s one of the linker tasks. It&rsquo;s one more task is to decide where to place each segment within the executable and to manage segments&#8217; addresses. In other words linker&rsquo;s task is a complecated one and there&rsquo;s no need to dig deeper right now.</p>

<p>Stm32f4 memory map can be found in it&rsquo;s datasheet which is available on ST site (<a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/datasheet/DM00037051.pdf">direct link</a>, page 69). That is the description of virtual address space - just the way of abstraction above all the peripherals inside MC. This address space is used by the core to deal with everything around it in one manner.</p>

<p>From memory map we can see where flash memory and SRAM memory are located. Their address boundaries are exactly what we need now. We need to provide the linker a possibility to manage addresses within our executable and to place segments into right places. The way to do that is to create a linker script. Linker has the default one which can be viewed in a such way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>arm-none-eabi-ld --verbose
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s huge ) And it won&rsquo;t help us. We need the new one for our MC. And it will be much simpler. <a href="https://sourceware.org/binutils/docs/ld/Scripts.html#Scripts">Ld documentation on scripts</a> is VERY useful reading to understand object files and linker scripting, so please refer to the doc and let me be less verbose).</p>

<p>Here is the script:</p>

<figure class='code'><figcaption><span> (basic.ld)</span> <a href='http://denyadzi.github.io/public/code/hello_asm/basic.ld'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">INCLUDE</span> <span class="n">stm32f407</span><span class="p">.</span><span class="n">memory</span>
</span><span class='line'>
</span><span class='line'><span class="n">ENTRY</span><span class="p">(</span><span class="n">_reset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">SECTIONS</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">int_vector_table</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(.</span><span class="n">int_vector_table</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="o">&gt;</span> <span class="n">REGION_INT_VECTORS</span>
</span><span class='line'>  <span class="p">.</span><span class="nl">text</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="o">&gt;</span> <span class="n">REGION_TEXT</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and here is the stm32f4 specific part included at the top:</p>

<figure class='code'><figcaption><span> (stm32f407.memory)</span> <a href='http://denyadzi.github.io/public/code/hello_asm/stm32f407.memory'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">MEMORY</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">FLASH</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">:</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="mh">0x8000000</span><span class="p">,</span>  <span class="n">LENGTH</span> <span class="o">=</span> <span class="mi">1024</span><span class="n">K</span>
</span><span class='line'>  <span class="n">RAM</span> <span class="p">(</span><span class="o">!</span> <span class="n">rx</span><span class="p">)</span> <span class="o">:</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="n">LENGTH</span> <span class="o">=</span> <span class="mi">192</span><span class="n">K</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">_estack</span> <span class="o">=</span> <span class="mh">0x20020000</span><span class="p">;</span>
</span><span class='line'><span class="n">REGION_ALIAS</span><span class="p">(</span><span class="s">&quot;REGION_TEXT&quot;</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
</span><span class='line'><span class="n">REGION_ALIAS</span><span class="p">(</span><span class="s">&quot;REGION_INT_VECTORS&quot;</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In stm32f407.memory file two regions of MC&rsquo;s virtual memory map are described (one note here: the space character in RAM&rsquo;s attributes &ldquo;! rx&rdquo; is nessecary because of some bug - without the space this file should not be included via INCLUDE command but pasted directly into basic.ld - then linkage goes fine). This file is included in a script basic.ld. In the script file we just describe regions and order in which input sections should be placed in an output object file. You may also just download these files.</p>

<p>There&rsquo;s one more section generated automatically. It&rsquo;s called .ARM.attributes - I didn&rsquo;t mention it in a script as I&rsquo;m not sure what is it for at the moment and we don&rsquo;t need to use it in a current code. The linker automatically places unmapped sections right after all mapped sections in the output file.</p>

<p>From this moment we can write assembly code just using only .text section and a linker will correctly form an executable. But.. there&rsquo;s one more section called .int_vector_table and which is placed at the beginning of the executable&hellip;</p>

<h2>The MC power on</h2>

<p>Actually there&rsquo;s no need at ENTRY command right now in our linker script which stays for an entry point. After the system is powered on the MC core reads the first word of flash memory - that&rsquo;s the stack top address which is loaded in sp register. So the entry point is known to the core and is equal to the beginning of the flash memory. The second word in the flash is assumed to be the reset handler address and the second step is to jump to that address. The remaining execution process depends on the loaded code or on occasions of hardware interrupts which are not covered in this post. Reset is also an interrupt and when it occurs (for example we push the reset button) the core just reads the reset handler address (or &ldquo;vector&rdquo;) again and jumps to it. The rest of interrupts act the same. The storage of interrupts&#8217; handlers are fixed (interrupt vectors table) - that&rsquo;s how the core is able to jump to the right place on a particular interrupt event.</p>

<h2>The blinking program</h2>

<p>Here is the code:</p>

<figure class='code'><figcaption><span> (main.S)</span> <a href='http://denyadzi.github.io/public/code/hello_asm/main.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'>    <span class="na">.syntax</span> <span class="no">unified</span>
</span><span class='line'>    <span class="na">.cpu</span> <span class="no">cortex-m4</span>
</span><span class='line'>    <span class="na">.fpu</span> <span class="no">softvfp</span>
</span><span class='line'>    <span class="na">.thumb</span>
</span><span class='line'>
</span><span class='line'><span class="c">#define RCC_BASE        0x40023800</span>
</span><span class='line'><span class="c">#define RCC_AHB1ENR     RCC_BASE + 0x30 </span>
</span><span class='line'><span class="c">#define GPIOD_BASE      0x40020C00</span>
</span><span class='line'><span class="c">#define GPIOD_MODER     GPIOD_BASE</span>
</span><span class='line'><span class="c">#define GPIOD_ODR       GPIOD_BASE + 0x14</span>
</span><span class='line'>
</span><span class='line'><span class="c">#define GPIODEN         1 &lt;&lt; 3</span>
</span><span class='line'><span class="c">#define MODER15_OUT     1 &lt;&lt; 30</span>
</span><span class='line'><span class="c">#define MODER14_OUT     1 &lt;&lt; 28</span>
</span><span class='line'><span class="c">#define MODER13_OUT     1 &lt;&lt; 26</span>
</span><span class='line'><span class="c">#define MODER12_OUT     1 &lt;&lt; 24</span>
</span><span class='line'><span class="c">#define LED_BLUE        1 &lt;&lt; 15</span>
</span><span class='line'><span class="c">#define LED_RED         1 &lt;&lt; 14</span>
</span><span class='line'><span class="c">#define LED_ORANGE      1 &lt;&lt; 13</span>
</span><span class='line'><span class="c">#define LED_GREEN       1 &lt;&lt; 12</span>
</span><span class='line'><span class="c">#define DELAY           0x000F</span>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>    <span class="no">.text</span>
</span><span class='line'>  <span class="na">.weak</span>     <span class="no">_reset</span>              <span class="err">/</span><span class="p">*</span> <span class="no">that</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">because</span> <span class="no">of</span> <span class="no">declaring</span> <span class="no">it</span> <span class="no">as</span> <span class="no">an</span> <span class="no">entry</span> <span class="no">point</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>  <span class="na">.type</span>     <span class="no">_reset</span><span class="p">,</span> <span class="err">%</span><span class="no">function</span>
</span><span class='line'><span class="nl">_reset:</span>
</span><span class='line'>    <span class="nf">ldr</span>     <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">RCC_AHB1ENR</span>    <span class="err">/</span><span class="p">*</span> <span class="no">firstly</span><span class="p">,</span> <span class="no">to</span> <span class="no">use</span> <span class="no">any</span> <span class="no">peripheral</span><span class="p">,</span> <span class="no">the</span> <span class="no">clock</span> <span class="no">should</span> <span class="no">be</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="no">ldr</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>            <span class="err">/</span><span class="p">*</span> <span class="no">enabled</span> <span class="no">for</span> <span class="no">it.</span> <span class="no">Different</span> <span class="no">registers</span> <span class="no">are</span> <span class="no">responsible</span> <span class="no">for</span> <span class="no">that</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                <span class="err">/*</span> <span class="err">(</span><span class="nf">see</span> <span class="no">reference</span> <span class="no">manual</span><span class="err">&#39;</span><span class="no">s</span> <span class="err">&quot;</span><span class="no">Reset</span> <span class="no">and</span> <span class="no">clock</span> <span class="no">control</span><span class="err">&quot;</span> <span class="no">section</span> <span class="no">on</span> <span class="no">page</span> <span class="mi">210</span><span class="p">).</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                <span class="err">/*</span> <span class="nf">For</span> <span class="no">use</span> <span class="no">of</span> <span class="no">GPIOD</span> <span class="no">it</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">clock</span> <span class="no">is</span> <span class="no">enabled</span> <span class="no">in</span> <span class="no">RCC_AHB1ENR</span> <span class="no">register</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">orr</span>     <span class="no">r1</span><span class="p">,</span> <span class="no">GPIODEN</span>         <span class="err">/</span><span class="p">*</span> <span class="no">by</span> <span class="no">setting</span> <span class="no">GPIODEN</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">ldr</span>     <span class="no">r0</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_MODER</span>    <span class="err">/</span><span class="p">*</span> <span class="no">port</span> <span class="no">mode</span> <span class="no">configuration</span> <span class="no">ragister</span> <span class="p">(</span><span class="no">input</span><span class="p">,</span><span class="no">output</span><span class="p">,</span> <span class="no">etc</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">=</span><span class="p">(</span><span class="no">MODER15_OUT</span> <span class="err">|</span> <span class="no">MODER14_OUT</span> <span class="err">|</span> <span class="no">MODER13_OUT</span> <span class="err">|</span> <span class="no">MODER12_OUT</span><span class="p">)</span>
</span><span class='line'>    <span class="nf">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r0</span><span class="err">]</span>            <span class="err">/</span><span class="p">*</span> <span class="no">configuring</span> <span class="no">GPIOD</span> <span class="no">pins</span> <span class="mi">12</span><span class="p">-</span><span class="mi">15</span> <span class="no">as</span> <span class="no">outputs</span> <span class="no">where</span> <span class="no">LEDs</span> <span class="no">are</span> <span class="no">connected</span> <span class="no">to</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">mov</span>     <span class="no">r1</span><span class="p">,</span> <span class="mi">0</span>              <span class="err">/</span><span class="p">*</span> <span class="no">clearing</span> <span class="no">for</span> <span class="no">further</span> <span class="no">LED</span> <span class="no">selection</span>    <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">ldr</span>     <span class="no">r2</span><span class="p">,</span> <span class="err">=</span><span class="no">GPIOD_ODR</span>      <span class="err">/</span><span class="p">*</span> <span class="no">GPIOD</span> <span class="no">output</span> <span class="no">data</span> <span class="no">register</span>  <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                <span class="err">/*</span> <span class="nf">writing</span> <span class="no">to</span> <span class="no">it</span> <span class="no">controls</span> <span class="no">pins</span><span class="err">&#39;</span> <span class="no">voltage</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="nl">.Lblink:</span>
</span><span class='line'>    <span class="nf">movw</span>    <span class="no">r1</span><span class="p">,</span> <span class="no">LED_GREEN</span>      
</span><span class='line'>    <span class="no">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r2</span><span class="err">]</span>            <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">LED_GREEN</span> <span class="no">bit</span> <span class="no">on</span> <span class="no">GPIOD_ODR</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>      <span class="no">.Ldelay</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>    <span class="no">r1</span><span class="p">,</span> <span class="no">LED_BLUE</span>
</span><span class='line'>    <span class="no">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r2</span><span class="err">]</span>            <span class="err">/</span><span class="p">*</span> <span class="no">setting</span> <span class="no">LED_BLUE</span> <span class="no">bit</span> <span class="no">on</span> <span class="no">GPIOD_ODR</span>  <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>      <span class="no">.Ldelay</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pause</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">movw</span>    <span class="no">r1</span><span class="p">,</span> <span class="no">LED_RED</span>
</span><span class='line'>    <span class="nf">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r2</span><span class="err">]</span>            <span class="err">/</span><span class="p">*</span> <span class="no">etc</span>  <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bl</span>      <span class="no">.Ldelay</span>
</span><span class='line'>    <span class="nf">movw</span>    <span class="no">r1</span><span class="p">,</span> <span class="no">LED_ORANGE</span>
</span><span class='line'>    <span class="nf">str</span>     <span class="no">r1</span><span class="p">,</span> <span class="err">[</span><span class="no">r2</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">bl</span>      <span class="no">.Ldelay</span>
</span><span class='line'>    <span class="nf">b</span>       <span class="no">.Lblink</span>
</span><span class='line'>
</span><span class='line'><span class="nl">.Ldelay:</span>
</span><span class='line'>    <span class="nf">movt</span>    <span class="no">r0</span><span class="p">,</span> <span class="no">DELAY</span>           <span class="err">/</span><span class="p">*</span> <span class="no">moving</span> <span class="no">DELAY</span> <span class="no">value</span> <span class="no">into</span> <span class="no">high</span> <span class="no">halfword</span> <span class="no">of</span> <span class="no">the</span> <span class="no">register</span>  <span class="p">*</span><span class="err">/</span>
</span><span class='line'><span class="err">1:</span>                              <span class="err">/*</span> <span class="nf">to</span> <span class="no">make</span> <span class="no">a</span> <span class="no">big</span> <span class="no">number</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">subs</span>    <span class="no">r0</span><span class="p">,</span> <span class="no">r0</span><span class="p">,</span> <span class="mi">1</span>           <span class="err">/</span><span class="p">*</span> <span class="no">and</span> <span class="no">just</span> <span class="no">spend</span> <span class="no">time</span> <span class="no">substracting</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="nf">bne</span>     <span class="mi">1</span><span class="no">b</span>
</span><span class='line'>    <span class="nf">bx</span>      <span class="no">lr</span>                  <span class="err">/</span><span class="p">*</span> <span class="no">return</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.size</span>   <span class="no">_reset</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_reset</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="na">.section</span>    <span class="no">.int_vector_table</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="err">%</span><span class="no">progbits</span>   <span class="err">/</span><span class="p">*</span> <span class="no">interrupt</span> <span class="no">table</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                                <span class="err">/*</span> <span class="err">&quot;</span><span class="nf">a</span><span class="err">&quot;</span> <span class="p">-</span> <span class="no">tells</span> <span class="no">that</span> <span class="no">section</span> <span class="no">is</span> <span class="no">allocatable</span>  <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                                <span class="err">/*</span> <span class="err">(</span><span class="nf">see</span> <span class="no">ld</span> <span class="no">manual</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                                <span class="err">/*</span> <span class="err">%</span><span class="nf">progbits</span> <span class="p">-</span> <span class="no">tells</span> <span class="no">that</span> <span class="no">section</span> <span class="no">contains</span> <span class="no">data</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>                                                <span class="err">/*</span> <span class="err">(</span><span class="nf">see</span> <span class="no">gas</span> <span class="no">manual</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="na">.type</span>   <span class="no">basic_vectors</span><span class="p">,</span> <span class="err">%</span><span class="no">object</span>
</span><span class='line'><span class="nl">basic_vectors:</span>
</span><span class='line'>    <span class="na">.word</span>   <span class="no">_estack</span>             <span class="err">/</span><span class="p">*</span> <span class="no">stack</span> <span class="no">top</span> <span class="no">address</span> <span class="p">(</span><span class="no">declared</span> <span class="no">in</span> <span class="no">basic.ld</span><span class="p">)</span> <span class="p">-</span> <span class="no">the</span> <span class="no">last</span> <span class="no">SRAM</span> <span class="no">address</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>    <span class="na">.word</span>   <span class="no">_reset</span>              <span class="err">/</span><span class="p">*</span> <span class="no">the</span> <span class="no">address</span> <span class="no">of</span> <span class="no">a</span> <span class="no">reset</span> <span class="no">handler</span> <span class="p">*</span><span class="err">/</span>
</span><span class='line'>
</span><span class='line'>    <span class="na">.size</span>   <span class="no">basic_vectors</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">basic_vectors</span>
</span></code></pre></td></tr></table></div></figure>


<p>I tried to write self-expanatory code with comments, so I won&rsquo;t stop on it&rsquo;s contents. If you have any questions feel free to send me a letter. Now let me describe the compilation process. This code has to be compiled with gcc, but not with as. That&rsquo;s because it uses the power of preprocessing stage to calculate different values in a set of #define. The following commands need to be run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>arm-none-eabi-gcc -Wall -Wextra -o main.elf -nostdlib -mcpu<span class="o">=</span>cortex-m4 -mthumb -Tbasic.ld main.S
</span><span class='line'><span class="nv">$ </span>arm-none-eabi-objcopy -O binary main.elf main.bin
</span></code></pre></td></tr></table></div></figure>


<p>The first one runs preprocessing, assembling and linking stages and silently generates ELF-format executable if there are no errors. Note some new parameters. The -nostdlib parameter tells the linker not to link standard c library, -Tbasic.ld passes the linker script to the ld. The script file should be present at current directory together with the source.</p>

<p>The second just transformes the ELF-format executable which can be run in a linux environment into a binary suitable to be executed by MC.</p>

<p>Huuuuh! The final step is to burn our binary file into discovery board. Connect the board and run the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>st-flash write main.bin 0x8000000
</span></code></pre></td></tr></table></div></figure>


<p>Read carefully the docs on stlink. If everything is OK - the LEDs are already blinking. Here is a compiled executable - <a href="http://denyadzi.github.io/public/code/hello_asm/main.bin">download</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Installing Neccessary Tools for Stm32f4discovery]]></title>
    <link href="http://denyadzi.github.io/blog/2014/12/25/installing-neccessary-tools-for-stm32f4discovery/"/>
    <updated>2014-12-25T07:12:20+03:00</updated>
    <id>http://denyadzi.github.io/blog/2014/12/25/installing-neccessary-tools-for-stm32f4discovery</id>
    <content type="html"><![CDATA[<p>Hello everyone! This post starts my <a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1848/PF252419?s_searchtype=partnumber">stm32f4discovery</a> learning experience story. This board truely deserves only good words to describe with. Big thanks to ST. That&rsquo;s the one I have: <img src="http://denyadzi.github.io/public/images/tools/stm32f4DISCOVERY.JPG"></p>

<!--more-->


<p>The trip to the dark side is a comparatevely low level experience. It&rsquo;s like a trip to the wild where we need to use a kind of primitive tools. I think it is the right way of learning - especially at the beginning. I mean - no IDE. Let&rsquo;s leave IDE for rapid development.</p>

<p>In this post we&rsquo;re going to install tools under gnu/linux (mb it will be possible to install them for windows too) needed to make binaries for our ARM processor, load, debug them and have fun of everything working.</p>

<p>So, these tools are:</p>

<ul>
<li>a toolchain built for arm-architecture (<a href="https://en.wikipedia.org/wiki/GNU_toolchain">GNU toolchain</a>)</li>
<li>a programmer (not another one person but a software driver for embedded in stm32f4discovery piece of hardware called <a href="http://www.st.com/web/en/catalog/tools/FM146/CL1984/SC720/SS1450/PF251168?s_searchtype=reco">STLink</a></li>
</ul>


<p>I&rsquo;ve tested the following on Debian 7 Wheezy 64bit and on Fedora 15 32bit.</p>

<h2>Toolchain</h2>

<p>Debian users can refer to <a href="https://wiki.debian.org/EmdebianToolchain">this</a> tutorial to manage the toolchain installation.</p>

<p>I preferred more universal way, though. Thanks to <a href="https://launchpad.net/~team-gcc-arm-embedded">GCC ARM Embedded Maintainers team</a> we&rsquo;ve got <a href="https://launchpad.net/gcc-arm-embedded">this pre-built toolchain</a>. We just download, unpack, add bin folder to PATH and it&rsquo;s done. The one thing to mention for 64bit OS users is that 32bit libc and libncurses are needed for this toolchain to work (see the <a href="https://launchpadlibrarian.net/192227680/readme.txt">readme.txt</a> for more detailed instructions).</p>

<p>To test our toolchain let&rsquo;s write a little assembly code:</p>

<figure class='code'><figcaption><span> (test.S)</span> <a href='http://denyadzi.github.io/public/code/tools/test.S'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Gas'><span class='line'><span class="na">.section</span>    <span class="no">.text</span>
</span><span class='line'>    <span class="nf">mov</span>     <span class="no">r0</span><span class="p">,</span> <span class="c">#0xFF</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Then, in the console :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>arm-none-eabi-as -mthumb -mcpu<span class="o">=</span>cortex-m4 -o test.o test.S
</span></code></pre></td></tr></table></div></figure>


<p>In this command we tell the assembler that we&rsquo;re using <a href="http://en.wikipedia.org/wiki/ARM_architecture#Thumb">thumb instruction set</a> and we&rsquo;re writing code for <a href="http://en.wikipedia.org/wiki/ARM_Cortex-M#Cortex-M4">Cortex-M4 core</a>. If no complains from command line - we&rsquo;re done with the toolchain.</p>

<h2>STLink</h2>

<p>To get STLink working is also fairly simple. It can be found on a <a href="https://github.com/texane/stlink">github repository</a>. Dependencies we need to resolve are: libusb (of version >=1.0), libusb-dev and pkg-config packages. Please consult the <a href="https://github.com/texane/stlink/blob/master/README">README</a> file for detailed instructions.</p>

<p>To test st-link tools being installed correctly, add the STLink installation directory into your PATH environment variable and just type in the console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>st-flash
</span></code></pre></td></tr></table></div></figure>


<p>And the response you should get is like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>invalid <span class="nb">command </span>line
</span><span class='line'>stlinkv1 <span class="nb">command </span>line: ./flash <span class="o">[</span>--debug<span class="o">]</span> <span class="o">[</span>--reset<span class="o">]</span> <span class="o">{</span><span class="nb">read</span><span class="p">|</span>write<span class="o">}</span> /dev/sgX path addr &lt;size&gt;
</span><span class='line'>stlinkv1 <span class="nb">command </span>line: ./flash <span class="o">[</span>--debug<span class="o">]</span> /dev/sgX erase
</span><span class='line'>stlinkv2 <span class="nb">command </span>line: ./flash <span class="o">[</span>--debug<span class="o">]</span> <span class="o">[</span>--reset<span class="o">]</span> <span class="o">{</span><span class="nb">read</span><span class="p">|</span>write<span class="o">}</span> path addr &lt;size&gt;
</span><span class='line'>stlinkv2 <span class="nb">command </span>line: ./flash <span class="o">[</span>--debug<span class="o">]</span> erase
</span><span class='line'>                       use hex format <span class="k">for</span> addr and &lt;size&gt;
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it. Next step is to write a traditional leds-blinking program. Feel free to contact me if you have smth to ask or talk about</p>
]]></content>
  </entry>
  
</feed>
